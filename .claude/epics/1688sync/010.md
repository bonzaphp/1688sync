---
name: 1688sync-task-010-部署文档-Docker化
status: open
created: 2025-11-18T13:09:28Z
updated: 2025-11-18T13:09:28Z
github: ""
depends_on:
  - "1688sync-task-001-存储系统"
  - "1688sync-task-002-核心技术"
  - "1688sync-task-003-调度队列"
  - "1688sync-task-004-数据同步"
  - "1688sync-task-005-命令行工具"
  - "1688sync-task-006-Web-API"
  - "1688sync-task-007-管理界面"
  - "1688sync-task-008-监控日志"
  - "1688sync-task-009-性能优化"
parallel: true
conflicts_with: []
---

## 任务描述
完成1688sync系统的Docker容器化部署，包括容器镜像构建、Docker Compose配置、Kubernetes部署、CI/CD流水线，以及完整的部署文档。

## 目标
提供生产就绪的容器化部署方案，支持多种部署环境（开发、测试、生产），确保系统易于部署、扩展和维护。

## Acceptance Criteria
- [ ] 完成所有服务的Docker镜像构建
- [ ] 配置Docker Compose多环境部署
- [ ] 提供Kubernetes部署配置
- [ ] 完成CI/CD流水线配置（GitHub Actions/GitLab CI）
- [ ] 编写完整的部署文档
- [ ] 配置环境变量和配置管理
- [ ] 完成数据持久化方案
- [ ] 配置负载均衡和服务发现
- [ ] 实现健康检查和自动重启
- [ ] 配置日志收集和监控
- [ ] 完成安全配置（网络、密钥管理）
- [ ] 提供灾备和恢复方案

## Technical Details

### 容器化架构
```
┌─────────────────────────────────────────────────────────┐
│                    负载均衡层                            │
│  ┌─────────────────┐  ┌─────────────────────────────────┐ │
│  │   Nginx         │  │        AWS ALB / K8s Ingress   │ │
│  │  (SSL/Term)     │  │                                 │ │
│  └─────────────────┘  └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│                   应用服务层                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │
│  │   Frontend  │ │    API      │ │      CLI            │ │
│  │   (React)   │ │   (FastAPI) │ │    (Python)         │ │
│  └─────────────┘ └─────────────┘ └─────────────────────┘ │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│                  业务服务层                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │
│  │ Sync Service│ │  Queue      │ │   Monitoring        │ │
│  │   (Python)  │ │  Service    │ │    Service          │ │
│  └─────────────┘ │   (Celery)   │ │    (Prometheus)     │ │
│                  └─────────────┘ └─────────────────────┘ │
└─────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────┐
│                   数据存储层                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐ │
│  │ PostgreSQL  │ │    Redis    │ │    Elasticsearch    │ │
│  │  (Primary)  │ │   (Cache)   │ │      (Logs)         │ │
│  └─────────────┘ └─────────────┘ └─────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### Docker镜像构建

#### 1. 核心服务镜像
```dockerfile
# Dockerfile.api - FastAPI应用
FROM python:3.11-slim as builder

# 安装构建依赖
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 创建虚拟环境
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# 复制依赖文件
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .
RUN pip install --no-cache-dir .

# 生产阶段
FROM python:3.11-slim

# 创建非root用户
RUN groupadd -r app && useradd -r -g app app

# 安装运行时依赖
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 从构建阶段复制虚拟环境
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# 设置工作目录
WORKDIR /app

# 复制应用代码
COPY --from=builder /app /app

# 切换到非root用户
USER app

# 健康检查
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# 暴露端口
EXPOSE 8000

# 启动命令
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

```dockerfile
# Dockerfile.frontend - React应用
FROM node:18-alpine as builder

# 设置工作目录
WORKDIR /app

# 复制package文件
COPY package*.json ./
RUN npm ci --only=production

# 复制源代码
COPY . .

# 构建应用
RUN npm run build

# Nginx服务阶段
FROM nginx:alpine

# 复制构建产物
COPY --from=builder /app/build /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/nginx.conf

# 健康检查
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:80/health || exit 1

# 暴露端口
EXPOSE 80
```

#### 2. 数据库镜像
```dockerfile
# Dockerfile.postgres - 自定义PostgreSQL
FROM postgres:15-alpine

# 安装扩展
RUN apk add --no-cache \
    postgresql15-contrib \
    postgresql15-pgcrypto

# 复制初始化脚本
COPY init-scripts/ /docker-entrypoint-initdb.d/

# 设置环境变量
ENV POSTGRES_DB=1688sync
ENV POSTGRES_USER=1688sync
ENV POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password

# 复制配置
COPY postgresql.conf /etc/postgresql/postgresql.conf
COPY pg_hba.conf /etc/postgresql/pg_hba.conf

# 暴露端口
EXPOSE 5432
```

### Docker Compose配置

#### 1. 生产环境配置
```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # 负载均衡
  nginx:
    image: nginx:alpine
    container_name: 1688sync-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - api
      - frontend
    restart: unless-stopped
    networks:
      - 1688sync-network

  # 前端应用
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
    container_name: 1688sync-frontend
    restart: unless-stopped
    networks:
      - 1688sync-network

  # API服务
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
      target: production
    container_name: 1688sync-api
    env_file:
      - .env.production
    volumes:
      - ./config:/app/config
      - ./logs/api:/app/logs
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - 1688sync-network
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # 调度队列
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.api
      target: production
    command: celery -A app.worker worker --loglevel=info --concurrency=4
    container_name: 1688sync-worker
    env_file:
      - .env.production
    volumes:
      - ./config:/app/config
      - ./logs/worker:/app/logs
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    networks:
      - 1688sync-network
    deploy:
      replicas: 2

  # 监控服务
  monitoring:
    image: prom/prometheus:latest
    container_name: 1688sync-monitoring
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped
    networks:
      - 1688sync-network

  # 数据存储
  postgres:
    image: postgres:15-alpine
    container_name: 1688sync-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-1688sync}
      POSTGRES_USER: ${POSTGRES_USER:-1688sync}
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    secrets:
      - postgres_password
    restart: unless-stopped
    networks:
      - 1688sync-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

  # 缓存
  redis:
    image: redis:7-alpine
    container_name: 1688sync-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - 1688sync-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # 日志收集
  elasticsearch:
    image: elasticsearch:8.8.0
    container_name: 1688sync-elasticsearch
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - xpack.security.enabled=false
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    restart: unless-stopped
    networks:
      - 1688sync-network

  kibana:
    image: kibana:8.8.0
    container_name: 1688sync-kibana
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    restart: unless-stopped
    networks:
      - 1688sync-network

# 网络配置
networks:
  1688sync-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# 数据卷
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  elasticsearch_data:
    driver: local
  prometheus_data:
    driver: local

# 密钥管理
secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
```

### Kubernetes部署

#### 1. 命名空间和配置
```yaml
# k8s/namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: 1688sync
  labels:
    name: 1688sync
    environment: production
```

```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: 1688sync-config
  namespace: 1688sync
data:
  DATABASE_URL: "postgresql://user:pass@postgres:5432/1688sync"
  REDIS_URL: "redis://redis:6379/0"
  ELASTICSEARCH_URL: "http://elasticsearch:9200"
  LOG_LEVEL: "INFO"
  MAX_WORKERS: "4"
  BATCH_SIZE: "100"
```

#### 2. 应用部署
```yaml
# k8s/api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: 1688sync-api
  namespace: 1688sync
  labels:
    app: 1688sync-api
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
  selector:
    matchLabels:
      app: 1688sync-api
  template:
    metadata:
      labels:
        app: 1688sync-api
    spec:
      containers:
      - name: api
        image: 1688sync/api:latest
        ports:
        - containerPort: 8000
        envFrom:
        - configMapRef:
            name: 1688sync-config
        - secretRef:
            name: 1688sync-secrets
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 2Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
      volumes:
      - name: config-volume
        configMap:
          name: 1688sync-config
```

#### 3. 服务和入口
```yaml
# k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: 1688sync-ingress
  namespace: 1688sync
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
  - hosts:
    - api.1688sync.com
    - admin.1688sync.com
    secretName: 1688sync-tls
  rules:
  - host: api.1688sync.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: 1688sync-api
            port:
              number: 8000
  - host: admin.1688sync.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: 1688sync-frontend
            port:
              number: 80
```

### CI/CD流水线

#### 1. GitHub Actions
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        cd frontend && npm ci

    - name: Run tests
      run: |
        pytest tests/
        cd frontend && npm test

    - name: Run linting
      run: |
        flake8 .
        cd frontend && npm run lint

  build:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
    - uses: actions/checkout@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

    - name: Build and push API image
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        file: ./backend/Dockerfile.api
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

    - name: Build and push Frontend image
      uses: docker/build-push-action@v4
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}-frontend
        labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Deploy to Kubernetes
      uses: azure/k8s-deploy@v1
      with:
        manifests: |
          k8s/api-deployment.yaml
          k8s/frontend-deployment.yaml
        images: |
          ${{ needs.build.outputs.image-tag }}
```

### 环境配置

#### 1. 环境变量配置
```bash
# .env.production
# Database
POSTGRES_DB=1688sync
POSTGRES_USER=1688sync
POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
DATABASE_URL=postgresql://1688sync:${POSTGRES_PASSWORD}@postgres:5432/1688sync

# Redis
REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
REDIS_PASSWORD=your_redis_password

# API Configuration
APP_KEY=your_app_key
APP_SECRET=your_app_secret
API_SECRET_KEY=your_api_secret_key
JWT_SECRET_KEY=your_jwt_secret

# 1688 API
1688_APP_KEY=your_1688_app_key
1688_APP_SECRET=your_1688_app_secret
1688_API_URL=https://gw.api.taobao.com/router/rest

# Logging
LOG_LEVEL=INFO
LOG_FORMAT=json

# Monitoring
PROMETHEUS_ENABLED=true
METRICS_PORT=9090

# Security
CORS_ORIGINS=https://admin.1688sync.com
TRUSTED_HOSTS=1688sync.com,api.1688sync.com

# Performance
MAX_WORKERS=4
BATCH_SIZE=100
RETRY_TIMES=3
TIMEOUT=30
```

### 部署文档

#### 1. 快速部署指南
```markdown
# 1688sync 部署指南

## 系统要求
- Docker 20.10+
- Docker Compose 2.0+
- 4GB+ RAM
- 20GB+ 磁盘空间

## 快速开始

### 1. 克隆项目
```bash
git clone https://github.com/your-org/1688sync.git
cd 1688sync
```

### 2. 配置环境变量
```bash
cp .env.example .env.production
# 编辑 .env.production 文件
```

### 3. 准备密钥
```bash
mkdir -p secrets
echo "your_postgres_password" > secrets/postgres_password.txt
echo "your_redis_password" > secrets/redis_password.txt
chmod 600 secrets/*.txt
```

### 4. 启动服务
```bash
docker-compose -f docker-compose.prod.yml up -d
```

### 5. 初始化数据库
```bash
docker-compose -f docker-compose.prod.yml exec api python manage.py init-db
```

## 验证部署
```bash
# 检查服务状态
docker-compose -f docker-compose.prod.yml ps

# 检查API健康状态
curl http://localhost/api/v1/system/health

# 查看日志
docker-compose -f docker-compose.prod.yml logs -f api
```
```

## Effort Estimate
- **开发时间**: 6-8 天
- **测试时间**: 2-3 天
- **文档时间**: 2-3 天
- **部署验证时间**: 1-2 天

## 依赖任务
- **001-009**: 所有前置任务完成后进行最终部署

## 风险与缓解
1. **环境差异**
   - 缓解: 容器化确保环境一致性
2. **数据安全**
   - 缓解: 加密存储和密钥管理
3. **部署复杂度**
   - 缓解: 自动化部署和文档
4. **监控盲区**
   - 缓解: 全面的监控和告警

## 验收标准
1. 所有服务容器化成功
2. 多环境部署测试通过
3. CI/CD流水线正常工作
4. 部署文档完整准确
5. 安全配置合规
6. 性能测试通过
7. 灾备方案可执行
8. 通过PEER REVIEW